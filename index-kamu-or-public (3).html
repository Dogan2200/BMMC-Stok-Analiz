<!DOCTYPE html><html lang="tr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AVESORO BI – Hızlı Kurulum</title><script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script><style>body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:20px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #eee;padding:8px}thead th{background:#fafafa;position:sticky;top:0}</style></head><body><h2>AVESORO BI – Hızlı Kurulum</h2><p>Bu sayfa <code>/data.xlsx → /data.csv → /data.json</code> ve <code>/kamu/data.xlsx → /kamu/data.csv → /kamu/data.json</code> yollarını sırayla dener.</p><button id="save">Kaydet / Tek Dosya Paylaş</button><div id="status" style="margin:10px 0;color:#555"></div><div id="mount"></div><script>let RAW=[];function msg(t){document.getElementById('status').textContent=t;}const MONEY=n=>isFinite(n)?'$'+Math.round(n).toLocaleString('tr-TR'):'—';function render(){if(!RAW.length){document.getElementById('mount').innerHTML='<em>Veri yok.</em>';return}const rows=RAW.slice(0,50);let html='<table><thead><tr><th>Dönem</th><th>Depo</th><th>Stok</th><th>Dev</th><th>Gir</th><th>Çık</th><th>Kal</th></tr></thead><tbody>';for(const r of rows){html+=`<tr><td>${r.Donem||''}</td><td>${r.Depo||''}</td><td>${r.StokAdi||''}</td><td align="right">${MONEY(r.Devreden||0)}</td><td align="right">${MONEY(r.Giren||0)}</td><td align="right">${MONEY(r.Cikan||0)}</td><td align="right">${MONEY(r.Kalan||0)}</td></tr>`}html+='</tbody></table>';document.getElementById('mount').innerHTML=html;}function toNum(v){if(v==null||v==='')return 0;if(typeof v==='number')return v;let s=String(v).trim();const neg=/^\(.*\)$/.test(s);if(neg)s=s.replace(/[()]/g,'');s=s.replace(/[^\d.,-]/g,'');if(s.includes('.')&&s.includes(','))s=s.replace(/\./g,'').replace(',','.');else if(s.includes(',')&&!s.includes('.'))s=s.replace(',','.');let n=parseFloat(s);if(isNaN(n))n=0;return neg?-Math.abs(n):n}function deaccent(s=''){return s.replaceAll('İ','I').replaceAll('ı','i').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase()}const monthMap={ocak:1,oca:1,subat:2,sub:2,mart:3,mar:3,nisan:4,nis:4,mayis:5,may:5,haziran:6,haz:6,temmuz:7,tem:7,agustos:8,agu:8,eylul:9,eyl:9,ekim:10,eki:10,kasim:11,kas:11,aralik:12,ara:12};function normMonth(v){if(v==null||v==='')return'';if(typeof v==='number'){if(v>40000&&v<60000){const base=Date.UTC(1899,11,30);const ms=base+Math.round(v)*24*3600*1000;const d=new Date(ms);return `${d.getUTCFullYear()}-${('0'+(d.getUTCMonth()+1)).slice(-2)}`}}let s=deaccent(String(v).trim());let m=s.match(/(20\d{2})\D+([01]?\d)\b/);if(m)return `${m[1]}-${('0'+m[2]).slice(-2)}`;m=s.match(/(20\d{2})([01]\d)\b/);if(m)return `${m[1]}-${m[2]}`;const y=(s.match(/(20\d{2})/)||[])[1];for(const k of Object.keys(monthMap)){if(s.includes(k))return(y?y:'0000')+'-'+('0'+monthMap[k]).slice(-2)}return s}function normalizeRows(arr){if(!arr.length)return[];const map={};Object.keys(arr[0]).forEach(h=>{const k=deaccent(h);if(k.includes('donem'))map[h]='Donem';else if(k==='depo')map[h]='Depo';else if(k.startsWith('stok adi'))map[h]='StokAdi';else if(k.includes('devreden tutar'))map[h]='Devreden';else if(k.includes('giren tutar'))map[h]='Giren';else if(k.includes('cikan tutar'))map[h]='Cikan';else if(k.includes('kalan tutar'))map[h]='Kalan'});const out=[];for(const r of arr){const o={Donem:'',Depo:'',StokAdi:'',Devreden:0,Giren:0,Cikan:0,Kalan:0};for(const h of Object.keys(r)){const k=map[h];if(!k)continue;if(k==='Donem')o.Donem=normMonth(r[h]);else if(['Devreden','Giren','Cikan','Kalan'].includes(k))o[k]=toNum(r[h]);else o[k]=String(r[h]||'').trim()}if(o.Donem)out.push(o)}return out}async function loadFrom(path){try{const rx=await fetch(path.xlsx,{cache:'no-store'});if(rx.ok){const ab=await rx.arrayBuffer();const wb=XLSX.read(ab,{type:'array'});RAW=normalizeRows(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''}));msg('Yüklendi: '+path.xlsx);render();return true}}catch{}try{const rc=await fetch(path.csv,{cache:'no-store'});if(rc.ok){RAW=normalizeRows(Papa.parse?Papa.parse(await rc.text(),{header:true}).data:[]);msg('Yüklendi: '+path.csv);render();return true}}catch{}try{const rj=await fetch(path.json,{cache:'no-store'});if(rj.ok){RAW=await rj.json();msg('Yüklendi: '+path.json);render();return true}}catch{}return false}async function boot(){const paths=[{xlsx:'/data.xlsx',csv:'/data.csv',json:'/data.json'},{xlsx:'/kamu/data.xlsx',csv:'/kamu/data.csv',json:'/kamu/data.json'}];for(const p of paths){if(await loadFrom(p))return}msg('Veri bulunamadı. Lütfen public/ veya kamu/ içine data.xlsx (ya da data.csv/json) ekleyin.')}boot();document.getElementById('save').onclick=()=>{try{const data=RAW||[];let html=document.documentElement.outerHTML;const inject=`<script>window.EMBED_DATA=${JSON.stringify(data)};<\/script>`;html=html.includes('</body>')?html.replace('</body>',inject+'\n</body>'):html+inject;const blob=new Blob([html],{type:'text/html;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='AvesoroRapor.html';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}catch(e){alert('Kaydetme hatası');}};</script></body></html>